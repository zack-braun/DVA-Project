{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Accessing ProPublica's Congressional API"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "ProPublica provides API access to legislative data from the House, Senate and Library of Congress. This notebook attempts to explain the major functionality needed for our group project, but for more information you can check __[ProPublica's API documentation](https://projects.propublica.org/api-docs/congress-api/)__. Note that you'll need to get an API Key in order to access the information; users with an API key are restricted to 5000 requests per day. You can sign up at ProPublica's __[ProPublica's Data Store](https://www.propublica.org/datastore/api/propublica-congress-api)__.\n",
    "\n",
    "The Congressional API includes:\n",
    "- Roll-call vote data (1991 onward for House; 1989 onward for Senate)\n",
    "- Member data\n",
    "- Bill data (since 1995)\n",
    "- Floor actions\n",
    "- Committee data (including committee membership)\n",
    "- Personal explanation (related to missed votes)\n",
    "- Nomination data (2001 onward)\n",
    "- Other information\n",
    "\n",
    "For our purposes we are most interested in the roll-call vote, member, bill and committee data. This document will include a section explaining how to access each of these API endpoints and a description of the underlying data structure returned."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Base URL and Error Overview"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The ProPublica API uses a common base URL for its different API endpoits. The common URL is: <font color = blue>https://api.propublica.org/congress/v1/</font>. In each of the sections below, the additional parameters needed to search a given API endpoint are described. \n",
    "\n",
    "The API also uses the following error codes that are universal across the API endpoints and can be used to check whether a request failed and determine the reason.\n",
    "\n",
    "- 400 : Bad request (improperly formed)\n",
    "- 403 : Forbidden (request doesn't have authorization header)\n",
    "- 404 : Not found (specified record can't be found)\n",
    "- 406 : Not acceptable (you requested a format that is not JSON or XML)\n",
    "- 500 : Internal server error (ProPublica had server issue; try again later)\n",
    "- 503 : Service unavailable (service is currently down; try again later)\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Congressional Members "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "To start acquiring data on Congressional members it is first useful to retrieve a list of all the members. This is accomplished by adding the Congressional session and chamber to the base API URL and requesting that members.json be returned. \n",
    "\n",
    "**The format is: Base URL + {congress}/{chamber}/members.json**\n",
    "\n",
    "For example, the base URL with <font color=blue>115/senate/members.json</font> would request the list of senators in the 115th Congress, while <font color=blue>115/house/members.json</font> would request members of the House of Representatives from the 115th Congress. \n",
    "\n",
    "The code below illustrates how one could return this information easily via Python. However, in practice it would be necessary to loop through multiple Congressional sessions and also retrieve data for the House and Senate. Since legislator's can serve in multiple sessions and have different roles in those sessions, we'll need to look for potential duplicates in the returned data we plan to use for our project. \n",
    "\n",
    "There is also an API endpoint to get additional informatino for a specific member. This includes additional information on the member's roles on committees. But it seems like this might be more easily pulled via the committee API."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "api_uri                  object\n",
      "at_large                   bool\n",
      "contact_form             object\n",
      "crp_id                   object\n",
      "cspan_id                 object\n",
      "date_of_birth            object\n",
      "district                 object\n",
      "dw_nominate             float64\n",
      "facebook_account         object\n",
      "fax                      object\n",
      "fec_candidate_id         object\n",
      "first_name               object\n",
      "gender                   object\n",
      "geoid                    object\n",
      "google_entity_id         object\n",
      "govtrack_id              object\n",
      "icpsr_id                 object\n",
      "id                       object\n",
      "ideal_point              object\n",
      "in_office                  bool\n",
      "last_name                object\n",
      "last_updated             object\n",
      "leadership_role          object\n",
      "middle_name              object\n",
      "missed_votes            float64\n",
      "missed_votes_pct        float64\n",
      "next_election            object\n",
      "ocd_id                   object\n",
      "office                   object\n",
      "party                    object\n",
      "phone                    object\n",
      "rss_url                  object\n",
      "seniority                object\n",
      "short_title              object\n",
      "state                    object\n",
      "suffix                   object\n",
      "title                    object\n",
      "total_present           float64\n",
      "total_votes             float64\n",
      "twitter_account          object\n",
      "url                      object\n",
      "votes_with_party_pct    float64\n",
      "votesmart_id             object\n",
      "youtube_account          object\n",
      "dtype: object\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>api_uri</th>\n",
       "      <th>at_large</th>\n",
       "      <th>contact_form</th>\n",
       "      <th>crp_id</th>\n",
       "      <th>cspan_id</th>\n",
       "      <th>date_of_birth</th>\n",
       "      <th>district</th>\n",
       "      <th>dw_nominate</th>\n",
       "      <th>facebook_account</th>\n",
       "      <th>fax</th>\n",
       "      <th>...</th>\n",
       "      <th>state</th>\n",
       "      <th>suffix</th>\n",
       "      <th>title</th>\n",
       "      <th>total_present</th>\n",
       "      <th>total_votes</th>\n",
       "      <th>twitter_account</th>\n",
       "      <th>url</th>\n",
       "      <th>votes_with_party_pct</th>\n",
       "      <th>votesmart_id</th>\n",
       "      <th>youtube_account</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>https://api.propublica.org/congress/v1/members...</td>\n",
       "      <td>False</td>\n",
       "      <td>None</td>\n",
       "      <td>N00036633</td>\n",
       "      <td>76236</td>\n",
       "      <td>1954-09-16</td>\n",
       "      <td>5</td>\n",
       "      <td>0.508</td>\n",
       "      <td>CongressmanRalphAbraham</td>\n",
       "      <td>202-225-5639</td>\n",
       "      <td>...</td>\n",
       "      <td>LA</td>\n",
       "      <td>None</td>\n",
       "      <td>Representative</td>\n",
       "      <td>0.0</td>\n",
       "      <td>1212.0</td>\n",
       "      <td>RepAbraham</td>\n",
       "      <td>https://abraham.house.gov</td>\n",
       "      <td>96.98</td>\n",
       "      <td>155414</td>\n",
       "      <td>None</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>https://api.propublica.org/congress/v1/members...</td>\n",
       "      <td>False</td>\n",
       "      <td>None</td>\n",
       "      <td>N00035451</td>\n",
       "      <td>76386</td>\n",
       "      <td>1946-05-27</td>\n",
       "      <td>12</td>\n",
       "      <td>-0.469</td>\n",
       "      <td>CongresswomanAdams</td>\n",
       "      <td>202-225-1512</td>\n",
       "      <td>...</td>\n",
       "      <td>NC</td>\n",
       "      <td>None</td>\n",
       "      <td>Representative</td>\n",
       "      <td>2.0</td>\n",
       "      <td>1212.0</td>\n",
       "      <td>RepAdams</td>\n",
       "      <td>https://adams.house.gov</td>\n",
       "      <td>95.93</td>\n",
       "      <td>5935</td>\n",
       "      <td>None</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>https://api.propublica.org/congress/v1/members...</td>\n",
       "      <td>False</td>\n",
       "      <td>None</td>\n",
       "      <td>N00003028</td>\n",
       "      <td>45516</td>\n",
       "      <td>1965-07-22</td>\n",
       "      <td>4</td>\n",
       "      <td>0.361</td>\n",
       "      <td>RobertAderholt</td>\n",
       "      <td>202-225-5587</td>\n",
       "      <td>...</td>\n",
       "      <td>AL</td>\n",
       "      <td>None</td>\n",
       "      <td>Representative</td>\n",
       "      <td>0.0</td>\n",
       "      <td>1212.0</td>\n",
       "      <td>Robert_Aderholt</td>\n",
       "      <td>https://aderholt.house.gov</td>\n",
       "      <td>96.90</td>\n",
       "      <td>441</td>\n",
       "      <td>RobertAderholt</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>https://api.propublica.org/congress/v1/members...</td>\n",
       "      <td>False</td>\n",
       "      <td>None</td>\n",
       "      <td>N00033997</td>\n",
       "      <td>79994</td>\n",
       "      <td>1979-06-19</td>\n",
       "      <td>31</td>\n",
       "      <td>-0.285</td>\n",
       "      <td>reppeteaguilar</td>\n",
       "      <td>202-226-6962</td>\n",
       "      <td>...</td>\n",
       "      <td>CA</td>\n",
       "      <td>None</td>\n",
       "      <td>Representative</td>\n",
       "      <td>2.0</td>\n",
       "      <td>1212.0</td>\n",
       "      <td>reppeteaguilar</td>\n",
       "      <td>https://aguilar.house.gov</td>\n",
       "      <td>92.49</td>\n",
       "      <td>70114</td>\n",
       "      <td>None</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>https://api.propublica.org/congress/v1/members...</td>\n",
       "      <td>False</td>\n",
       "      <td>None</td>\n",
       "      <td>N00033720</td>\n",
       "      <td>62545</td>\n",
       "      <td>1951-11-07</td>\n",
       "      <td>12</td>\n",
       "      <td>0.611</td>\n",
       "      <td>CongressmanRickAllen</td>\n",
       "      <td>202-225-3377</td>\n",
       "      <td>...</td>\n",
       "      <td>GA</td>\n",
       "      <td>None</td>\n",
       "      <td>Representative</td>\n",
       "      <td>0.0</td>\n",
       "      <td>1212.0</td>\n",
       "      <td>reprickallen</td>\n",
       "      <td>https://allen.house.gov</td>\n",
       "      <td>97.91</td>\n",
       "      <td>136062</td>\n",
       "      <td>None</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>5 rows Ã— 44 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "                                             api_uri  at_large contact_form  \\\n",
       "0  https://api.propublica.org/congress/v1/members...     False         None   \n",
       "1  https://api.propublica.org/congress/v1/members...     False         None   \n",
       "2  https://api.propublica.org/congress/v1/members...     False         None   \n",
       "3  https://api.propublica.org/congress/v1/members...     False         None   \n",
       "4  https://api.propublica.org/congress/v1/members...     False         None   \n",
       "\n",
       "      crp_id cspan_id date_of_birth district  dw_nominate  \\\n",
       "0  N00036633    76236    1954-09-16        5        0.508   \n",
       "1  N00035451    76386    1946-05-27       12       -0.469   \n",
       "2  N00003028    45516    1965-07-22        4        0.361   \n",
       "3  N00033997    79994    1979-06-19       31       -0.285   \n",
       "4  N00033720    62545    1951-11-07       12        0.611   \n",
       "\n",
       "          facebook_account           fax  ... state suffix           title  \\\n",
       "0  CongressmanRalphAbraham  202-225-5639  ...    LA   None  Representative   \n",
       "1       CongresswomanAdams  202-225-1512  ...    NC   None  Representative   \n",
       "2           RobertAderholt  202-225-5587  ...    AL   None  Representative   \n",
       "3           reppeteaguilar  202-226-6962  ...    CA   None  Representative   \n",
       "4     CongressmanRickAllen  202-225-3377  ...    GA   None  Representative   \n",
       "\n",
       "  total_present total_votes  twitter_account                         url  \\\n",
       "0           0.0      1212.0       RepAbraham   https://abraham.house.gov   \n",
       "1           2.0      1212.0         RepAdams     https://adams.house.gov   \n",
       "2           0.0      1212.0  Robert_Aderholt  https://aderholt.house.gov   \n",
       "3           2.0      1212.0   reppeteaguilar   https://aguilar.house.gov   \n",
       "4           0.0      1212.0     reprickallen     https://allen.house.gov   \n",
       "\n",
       "  votes_with_party_pct votesmart_id  youtube_account  \n",
       "0                96.98       155414             None  \n",
       "1                95.93         5935             None  \n",
       "2                96.90          441   RobertAderholt  \n",
       "3                92.49        70114             None  \n",
       "4                97.91       136062             None  \n",
       "\n",
       "[5 rows x 44 columns]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "import requests\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "\n",
    "apiKey = \"AwB4zaxyUCsrdIPV2K9S863GD8rUMm98ZRjJaEGC\"\n",
    "baseUrl = \"https://api.propublica.org/congress/v1/\"\n",
    "\n",
    "# Required API options\n",
    "congress = [\"115\"]\n",
    "chamber = [\"house\", \"senate\"]\n",
    "endPoint = \"members.json\"\n",
    "\n",
    "# Make request\n",
    "r = requests.get(baseUrl + congress[0] + \"/\" + chamber[0] + \"/\" + endPoint, headers={'X-API-Key': apiKey})\n",
    "\n",
    "# Note: I'm not including error handling in current code, but one could check the \n",
    "if r.json()['status'] == 'OK':\n",
    "    members = r.json()['results'][0]['members']\n",
    "    membersDF = pd.DataFrame(members)\n",
    "    print(membersDF.dtypes)\n",
    "    display(membersDF.head())\n",
    "    \n",
    "else: \n",
    "    print(r.json()['status'])"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.2"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
